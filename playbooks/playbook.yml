# ---
# - name: Install and start Nginx on Ubuntu servers
#   hosts: ubuntu
#   become: true
#   remote_user: ubuntu

#   tasks:
#     - name: Update apt cache
#       apt:
#         update_cache: yes

#     - name: Install nginx
#       apt:
#         name: nginx
#         state: present

#     - name: Start and enable nginx
#       service:
#         name: nginx
#         state: started
#         enabled: true

#     - name: Create assets folder
#       ansible.builtin.file:
#         path: /usr/share/nginx/html/assets
#         state: directory

#     - name: Copy index file
#       ansible.builtin.copy:
#         src: index.html
#         dest: /usr/share/nginx/html/index.html

#     - name: Copy app.js
#       ansible.builtin.copy:
#         src: assets/app.js
#         dest: /usr/share/nginx/html/assets/app.js

#     - name: Copy styles.css
#       ansible.builtin.copy:
#         src: assets/styles.css
#         dest: /usr/share/nginx/html/assets/styles.css

#     - name: List nginx html directory
#       ansible.builtin.command: ls -ltr /usr/share/nginx/html
#       register: nginx_ls

#     - name: Show nginx html files
#       ansible.builtin.debug:
#         var: nginx_ls.stdout

---
- name: Install and start Nginx on all servers
  hosts: amazon,ubuntu
  become: true

  vars:
    web_root_map:
      amazon: /usr/share/nginx/html
      ubuntu: /var/www/html
    assets_files:
      - app.js
      - styles.css

  tasks:
    - name: Set web root for this host
      set_fact:
        web_root: "{{ web_root_map[group_names[0]] }}"

    - name: Update package cache (Amazon Linux)
      yum:
        name: "*"
        state: latest
      when: "'amazon' in group_names"

    - name: Update package cache (Ubuntu)
      apt:
        update_cache: yes
      when: "'ubuntu' in group_names"

    - name: Install nginx (Amazon Linux)
      yum:
        name: nginx
        state: present
      when: "'amazon' in group_names"

    - name: Install nginx (Ubuntu)
      apt:
        name: nginx
        state: present
      when: "'ubuntu' in group_names"

    - name: Start and enable nginx service
      service:
        name: nginx
        state: started
        enabled: yes

    - name: Create assets directory
      ansible.builtin.file:
        path: "{{ web_root }}/assets"
        state: directory
        mode: '0755'

    - name: Copy index.html
      ansible.builtin.copy:
        src: index.html
        dest: "{{ web_root }}/index.html"
        mode: '0644'

    - name: Copy asset files
      ansible.builtin.copy:
        src: "assets/{{ item }}"
        dest: "{{ web_root }}/assets/{{ item }}"
        mode: '0644'
      loop: "{{ assets_files }}"

    - name: List web root directory
      ansible.builtin.command: ls -ltr "{{ web_root }}"
      register: nginx_ls

    - name: Show nginx html files
      ansible.builtin.debug:
        var: nginx_ls.stdout

